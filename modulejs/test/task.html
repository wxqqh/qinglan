<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Task</title>
</head>
<body>
	<script type="text/javascript" src="../src/module.js"></script>
	<script type="text/javascript" src="../src/task.js"></script>
	<script type="text/javascript">
		var Task = require("Task");
		/*
		t = new Task(function() {
			return 1;
		});
		t.then(function(x) {
			console.log("t resolve 1 " + x);
			return x + 1;
		})
		.then(function(x) {
			console.log("t resolve 2 " + x);
			return x + 1;
		})
		.then(function(x) {
			console.log("t resolve last " + x);
		})
		.start();
		
		var t1 = new Task(function () {
			return 1;
		});
		t1.then(function(x) {
			console.log("t1 resolve 1  " + x);
			return x + 1;
		})
		.then(function(x) {
			console.log("t1 resolve 2  " + x);
			return new Task(function() {
				this.async = false;
				return "async callback"
			});
		})
		.then(function(value) {
			console.log(value); // log "async callback"
		})
		.start();

		var imgTask = new Task("http://www.baidu.com/img/bdlogo.gif");
		imgTask.then(function(url) {
			var t = this;
			return new Task(function() {
				var i = new Image();

				i.onload = function() {
					t.resolve(i);
				};
				i.onerror = function() {
					t.reject("loadError");
				};

				i.src = url;
			});
		}).then(function(img){
			console.log("load img success!!" + img.src);
		}, function(errmsg) {
			console.log("load img error" + errmsg);
		}).start();


		var imgTask = new Task("http://www.baidu.com/img/bdlogo.gif");
		imgTask.then(function(url) {
			var t = this;
			return new Task(function() {
				var i = new Image();

				i.onload = function() {
					t.resolve(i);
				};
				i.onerror = function() {
					t.reject("loadError");
				};

				i.src = url;
			});
		}).then(function(img){
			console.log("load img success!!" + img.src);
		}, function(errmsg) {
			console.log("load img error" + errmsg);
		}).start();
		
		var mapTask = Task.create("hehe").map(function(msg) {
			return {
				logo_smal: function() {
					var t = this;
					var url = "http://tb2.bdstatic.com/tb/static-common/img/search_logo_7098cbef.png?" + msg;

					return Task.create(function() {
						var i = new Image();

						i.onload = function() {
							t.resolve(i);
						};
						i.onerror = function() {
							t.reject("loadError");
						};

						i.src = url;
					});
				},
				logo_big: function() {
					
					var url = "http://www.baidu.com/img/bdlogo.gif?" + msg;

					return Task.create(function() {
						var t = this;
						var i = new Image();

						i.onload = function() {
							t.parentResolve(i);
						};
						i.onerror = function() {
							t.reject("loadError");
						};

						i.src = url;
					});
				}
			};
		}).then(function(ctx) {
			console.log(ctx)
		}).start();
		*/

	
	Task.create(1).then(function(ret){ // 这里的ret的值是create时候传的参数

		console.log("task start ret : " + ret); // ret is 1

		var x = ret + 1; // ret is 2

		// return 一个Task的实例

		return Task.create(function(){ // 这个操作成功结果是一个Task实例，则会block父Task下一个操作的执行，等这个子Task执行完后再执行父Task的下一个操作
			return x + 1; // return value is 3
		}).then(function(childTaskRet){
			
			console.log("childtask onFulfilled ret : " + childTaskRet); // childTaskRet is 3
			
			return childTaskRet + 1;
		});

	}).then(function(ret){ // 获取上一个操作的结果

		console.log("task onFulfilled ret : " + ret); // ret is 4
		
	}).start();

	// 拉取一个百度图片的异步回调例子
	Task.create("http://www.baidu.com/img/bdlogo.gif").then(function(url) {
		var t = this; // 保存引用
		return Task.create(function() {

			var i = new Image();
			i.onload = function() {
				t.resolve(i); // 这里是用父Task的引用直接调用resolve
			};
			i.onerror = function() {
				t.reject("loadError");  // 这里是用父Task的引用直接调用resolve
			};

			i.src = url;

			this.async = true; // 设置异步回调标志位
		});
	}).then(function(img) { // 成功回调里面获取到的是一个Image实例
		console.log("load img success!!" + img.src);
	}, function(errmsg) { // 获取失败，
		console.log("load img error" + errmsg);
		return "error";
	}).then(function(msg) {
		console.log(msg);
	}, function(msg) {
		console.log(msg);
	}).start();

	var loadImgAdapter = function (src) {
		return Task.create().then(function () {
			var self = this,
				i = new Image();

			i.onload = function() {
				self.parentResolve(i); // 通知父Task触发成功回调
			};
			i.onerror = function() {
				self.parentReject("loadError"); // 通知父Task触发成功回调
			};

			i.src = src;

			this.async = true; // 设置异步回调标志位
		});
	};
	// 通过
	Task.create(loadImgAdapter("http://www.baidu.com/img/bdlogo.gif")).then(function(img) {
		console.log("loadImgAdapter load img success!!" + img.src);
	}, function(errmsg) { // 获取失败，
		console.log("loadImgAdapter load img error" + errmsg);
	}).start();

loadImgAdapter("http://www.baidu.com/img/bdlogo.gif").then(function(img){
			console.log("loadImgAdapter load img success!!" + img.src);
		}).start();

	</script>
</body>
</html>
